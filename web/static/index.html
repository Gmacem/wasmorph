<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wasmorph - Demo</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/go/go.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; background: #f8f9fa; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { background: white; padding: 20px; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .nav { display: flex; justify-content: space-between; align-items: center; }
        .nav a { color: #007bff; text-decoration: none; margin-left: 20px; padding: 8px 16px; border-radius: 4px; }
        .nav a:hover { background: #f8f9fa; }
        .btn { background: #007bff; color: white; padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; text-decoration: none; display: inline-block; }
        .btn:hover { background: #0056b3; }
        .btn-danger { background: #dc3545; }
        .btn-danger:hover { background: #c82333; }
        .btn-success { background: #28a745; }
        .btn-success:hover { background: #218838; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; }
        .form-control { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; box-sizing: border-box; }
        .form-control:focus { outline: none; border-color: #007bff; box-shadow: 0 0 0 2px rgba(0,123,255,0.25); }
        .card { background: white; padding: 30px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .error { background: #f8d7da; color: #721c24; padding: 12px; border-radius: 6px; margin-bottom: 20px; }
        .code { background: #f8f9fa; padding: 20px; border-radius: 6px; font-family: 'Monaco', 'Menlo', monospace; font-size: 14px; overflow-x: auto; }
        .grid { display: grid; gap: 20px; }
        .flex { display: flex; gap: 10px; align-items: center; }
        
        /* CodeMirror customization */
        .CodeMirror {
            border: 1px solid #ddd;
            border-radius: 6px;
            min-height: 400px;
            font-size: 14px;
        }
        
        .CodeMirror:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
        }
        
        /* Syntax highlighting for Go */
        .go-keyword { color: #569cd6; }
        .go-string { color: #ce9178; }
        .go-comment { color: #6a9955; }
        .go-function { color: #dcdcaa; }
        .go-type { color: #4ec9b0; }
        .go-number { color: #b5cea8; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="nav">
                <h1 style="margin: 0; font-size: 24px;">Wasmorph</h1>
                <div>
                    <span>Welcome, admin</span>
                    <a href="#scripts">My Scripts</a>
                    <a href="#" onclick="logout(); return false;">Logout</a>
                </div>
            </div>
        </div>
        
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <div>
                    <h2 style="margin: 0 0 5px 0; font-size: 28px;">My Scripts</h2>
                    <p style="color: #666; margin: 0;">Manage your Go scripts</p>
                </div>
                <button onclick="openEditor()" class="btn">Create New Script</button>
            </div>
            
            <div id="scriptsContainer">
                <div style="text-align: center; padding: 60px 20px;">
                    <p style="color: #666; font-size: 18px;">No scripts found. Create your first script!</p>
                </div>
            </div>
        </div>
    </div>

    <div id="executeModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000;">
        <div style="background: white; border-radius: 8px; width: 500px; max-width: 90vw; max-height: 80vh; overflow-y: auto; box-sizing: border-box;">
            <div style="padding: 20px; border-bottom: 1px solid #ddd;">
                <h3 style="margin: 0; font-size: 20px;">Execute Script</h3>
            </div>
            <div style="padding: 20px;">
                <div class="form-group">
                    <label for="inputData">Input JSON</label>
                    <textarea id="inputData" rows="4" class="form-control code" placeholder='{"input": "test"}' style="width: 100%; box-sizing: border-box; resize: vertical;"></textarea>
                </div>
                <div id="resultContainer" style="display: none;">
                    <div class="form-group">
                        <label>Result</label>
                        <pre id="resultOutput" style="background: #f8f9fa; padding: 12px; border-radius: 6px; border: 1px solid #ddd; font-family: monospace; font-size: 14px; max-height: 200px; overflow-y: auto; white-space: pre-wrap; word-break: break-word;"></pre>
                    </div>
                </div>
                <div style="display: flex; justify-content: flex-end; gap: 10px;">
                    <button onclick="closeModal()" class="btn" style="background: #6c757d;">Cancel</button>
                    <button id="executeButton" onclick="confirmExecute()" class="btn">Execute</button>
                </div>
            </div>
        </div>
    </div>

    <div id="editorModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000;">
        <div style="background: white; border-radius: 8px; max-width: 800px; width: 95%; max-height: 90vh; overflow-y: auto;">
            <div style="padding: 20px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0; font-size: 20px;">Go Script Editor</h3>
                <button onclick="closeEditor()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666; padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">Ã—</button>
            </div>
            <div style="padding: 20px;">
                <div class="form-group">
                    <label for="scriptName">Script Name</label>
                    <input type="text" id="scriptName" class="form-control" placeholder="my-awesome-script">
                </div>
                <div class="form-group">
                    <label for="scriptCode">Go Code</label>
                    <textarea id="scriptCode" placeholder="package main

import (
    &quot;encoding/json&quot;
    &quot;fmt&quot;
)

func main() {
    result := map[string]interface{}{
        &quot;message&quot;: &quot;Hello from WASM!&quot;,
    }
    
    jsonData, _ := json.Marshal(result)
    fmt.Print(string(jsonData))
}"></textarea>
                </div>
                <div style="display: flex; justify-content: flex-end; gap: 10px;">
                    <button onclick="closeEditor()" class="btn" style="background: #6c757d;">Cancel</button>
                    <button id="saveButton" onclick="saveScript()" class="btn">Save Script</button>
                </div>
            </div>
        </div>
    </div>

    <script>
    let currentScriptName = '';
    let codeEditor = null;

    async function loadScripts() {
        try {
            const resp = await fetch('/api/v1/rules', { credentials: 'include' });
            if (resp.status === 401) {
                window.location.href = '/login.html';
                return;
            }
            const scripts = await resp.json();
            console.log('Loaded scripts:', scripts);
            
            const container = document.getElementById('scriptsContainer');
            if (scripts.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 60px 20px;"><p style="color: #666; font-size: 18px;">No scripts found. Create your first script!</p></div>';
            } else {
                let html = '';
                scripts.forEach(script => {
                    html += `
                        <div class="card" style="margin-bottom: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <h3 style="margin: 0 0 10px 0; font-size: 20px;">${script.name}</h3>
                                    <p style="color: #666; margin: 0;">Created: ${new Date(script.created_at).toLocaleDateString()}</p>
                                </div>
                                <div class="flex">
                                    <button onclick="editScript('${script.name}')" class="btn" style="background: #6c757d; margin-right: 10px;">Edit</button>
                                    <button onclick="executeScript('${script.name}')" class="btn btn-success" style="margin-right: 10px;">Execute</button>
                                    <button onclick="deleteScript('${script.name}')" class="btn btn-danger">Delete</button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                container.innerHTML = html;
            }
        } catch (err) {
            console.error('Failed to load scripts:', err);
        }
    }

    function openEditor(scriptName = '', scriptCode = '') {
        document.getElementById('editorModal').style.display = 'flex';
        document.getElementById('scriptName').value = scriptName;
        document.getElementById('scriptName').disabled = scriptName !== '';
        
        if (!codeEditor) {
            const textarea = document.getElementById('scriptCode');
            codeEditor = CodeMirror.fromTextArea(textarea, {
                mode: 'go',
                theme: 'monokai',
                lineNumbers: true,
                indentUnit: 4,
                tabSize: 4,
                lineWrapping: true,
                autoCloseBrackets: true,
                matchBrackets: true,
                foldGutter: true,
                gutters: ['CodeMirror-linenumbers', 'CodeMirror-foldgutter'],
                keyMap: "default"
            });
        }
        
        codeEditor.setValue(scriptCode);
        codeEditor.refresh();
        
        resetSaveButton();
        codeEditor.on('change', resetSaveButton);
    }

    function closeEditor() {
        document.getElementById('editorModal').style.display = 'none';
        document.getElementById('scriptName').disabled = false;
        resetSaveButton();
    }
    
    function resetSaveButton() {
        const saveButton = document.getElementById('saveButton');
        saveButton.textContent = 'Save Script';
        saveButton.style.background = '#007bff';
        saveButton.disabled = false;
        saveButton.style.cursor = 'pointer';
    }

    async function saveScript() {
        const name = document.getElementById('scriptName').value;
        const code = codeEditor ? codeEditor.getValue() : document.getElementById('scriptCode').value;
        
        if (!name || !code) {
            showError('Please fill in both script name and code');
            return;
        }
        
        const saveButton = document.getElementById('saveButton');
        const originalText = saveButton.textContent;
        saveButton.textContent = 'Saving...';
        saveButton.disabled = true;
        saveButton.style.cursor = 'not-allowed';

        try {
            const resp = await fetch('/api/v1/rules', {
                method: 'POST',
                credentials: 'include',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, code })
            });
            const data = await resp.json();
            if (!resp.ok) throw new Error(data.error);
            
            saveButton.textContent = 'Saved!';
            saveButton.style.background = '#28a745';
            loadScripts();
        } catch (err) {
            showError('Error: ' + err.message);
            saveButton.textContent = originalText;
            saveButton.style.background = '#007bff';
        } finally {
            saveButton.disabled = false;
        }
    }

    function executeScript(name) {
        currentScriptName = name;
        document.getElementById('executeModal').style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('executeModal').style.display = 'none';
        document.getElementById('resultContainer').style.display = 'none';
        document.getElementById('inputData').value = '';
        document.getElementById('resultOutput').textContent = '';
        currentScriptName = '';
    }

    async function confirmExecute() {
        const inputData = document.getElementById('inputData').value;
        const executeButton = document.getElementById('executeButton');
        const originalText = executeButton.textContent;
        
        executeButton.textContent = 'Executing...';
        executeButton.disabled = true;
        executeButton.style.cursor = 'not-allowed';
        
        try {
            const input = JSON.parse(inputData || '{}');
            const resp = await fetch(`/api/v1/rules/${currentScriptName}/execute`, {
                method: 'POST',
                credentials: 'include',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(input)
            });
            const data = await resp.json();
            if (!resp.ok) throw new Error(data.error);
            
            // Show result
            document.getElementById('resultOutput').textContent = JSON.stringify(data.result, null, 2);
            document.getElementById('resultContainer').style.display = 'block';
            
        } catch (err) {
            document.getElementById('resultOutput').textContent = 'Error: ' + err.message;
            document.getElementById('resultContainer').style.display = 'block';
        } finally {
            executeButton.textContent = originalText;
            executeButton.disabled = false;
            executeButton.style.cursor = 'pointer';
        }
    }

    async function editScript(name) {
        try {
            const detailResp = await fetch(`/api/v1/rules/${name}`, { credentials: 'include' });
            if (detailResp.ok) {
                const scriptData = await detailResp.json();
                console.log('Loaded script data:', scriptData);
                openEditor(name, scriptData.source_code || '');
            } else {
                const errorData = await detailResp.text();
                alert('Could not load script details: ' + errorData);
            }
        } catch (err) {
            alert('Error loading script: ' + err.message);
        }
    }

    async function deleteScript(name) {
        if (!confirm('Are you sure you want to delete this script?')) return;
        try {
            const resp = await fetch(`/api/v1/rules/${name}`, {
                method: 'DELETE',
                credentials: 'include'
            });
            const data = await resp.json();
            if (!resp.ok) throw new Error(data.error);
            alert(`Script "${name}" deleted`);
            loadScripts();
        } catch (err) {
            alert('Error: ' + err.message);
        }
    }

    function logout() {
        document.cookie = 'session=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;';
        window.location.href = '/login.html';
    }

    function showError(message) {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'error';
        errorDiv.textContent = message;
        errorDiv.style.position = 'fixed';
        errorDiv.style.top = '20px';
        errorDiv.style.right = '20px';
        errorDiv.style.zIndex = '10000';
        errorDiv.style.maxWidth = '400px';
        errorDiv.style.cursor = 'pointer';
        
        errorDiv.onclick = () => errorDiv.remove();
        
        document.body.appendChild(errorDiv);
        
        setTimeout(() => {
            if (errorDiv.parentNode) {
                errorDiv.remove();
            }
        }, 5000);
    }

    loadScripts();
    </script>
</body>
</html>
